# Binance 多网格交易系统

这是一个完整的币安多网格交易系统，严格按照需求文档实现了所有功能模块。

## 系统架构

### 核心模块

1. **数据结构 (types/)**
   - 定义了所有核心数据结构：订单、执行、配对、事件等
   - 实现了内存表：OrderTable、ExecutionTable、PairTable、OperationTable

2. **文件系统 (storage/)**
   - `ledger.jsonl`: 事件日志，记录所有系统事件
   - `snapshot.json`: 系统快照，用于快速恢复
   - `deferred_queue.jsonl`: 延迟订单队列
   - `rejections.jsonl`: 拒绝记录，用于错误分析

3. **订单配对逻辑 (pairing/)**
   - GridLegID机制：每个网格腿都有唯一标识
   - 买卖配对：自动匹配同一GridLegID的买卖订单
   - 部分成交处理：支持订单的部分执行
   - 盈亏计算：自动计算每个配对的盈亏

4. **启动恢复流程 (recovery/)**
   - 快照回放：从最新快照恢复内存状态
   - 事件重放：重放快照后的所有事件
   - 轻对账机制：与服务器数据进行对比和同步

5. **多网格支持 (multigrid/)**
   - X段网格：主要交易区间
   - A段网格：低价区间网格
   - B段网格：高价区间网格
   - 独立配置和管理每个网格

6. **错误处理 (errors/)**
   - 速率限制处理：自动检测和处理API限制
   - 余额不足处理：智能处理资金不足情况
   - 价格超出区间处理：处理价格异常情况
   - 网络错误重试机制

## 功能特性

### ✅ 已实现功能

1. **完整的数据结构系统**
   - 订单管理：支持各种订单状态和类型
   - 执行记录：详细记录每笔交易
   - 配对机制：自动配对买卖订单
   - 内存表：高效的数据存储和查询

2. **可靠的文件系统**
   - 事件日志：所有操作都有记录
   - 快照机制：支持快速恢复
   - 延迟队列：处理网络异常时的订单
   - 错误记录：完整的错误追踪

3. **智能配对引擎**
   - GridLegID机制：精确的订单配对
   - 实时盈亏计算：准确的收益统计
   - 部分成交支持：灵活的订单处理
   - 配对完整性验证：确保数据一致性

4. **强大的恢复系统**
   - 启动时自动恢复：无缝重启
   - 轻量级对账：与服务器数据同步
   - 延迟订单重提交：确保订单不丢失
   - 恢复统计报告：详细的恢复信息

5. **多网格管理**
   - 三段式网格：X/A/B段独立运行
   - 动态配置：支持运行时修改
   - 健康检查：自动监控网格状态
   - 统计报告：详细的网格统计

6. **完善的错误处理**
   - 错误分类：智能识别错误类型
   - 自动重试：网络错误自动重试
   - 速率限制：自动处理API限制
   - 错误统计：完整的错误分析

## 安装和配置

### 1. 环境要求

- Go 1.19+
- 币安API密钥（支持期货交易）

### 2. 配置文件

创建 `config.json` 文件：

```json
{
  "api": {
    "key_file": "api_keys.json",
    "base_url": "https://fapi.binance.com",
    "ws_url": "wss://fstream.binance.com"
  },
  "trading": {
    "symbol": "BTCUSDT",
    "base_asset": "BTC",
    "quote_asset": "USDT"
  },
  "system": {
    "data_dir": "./data",
    "log_level": "info",
    "snapshot_interval": 300,
    "health_check_interval": 60
  },
  "recovery": {
    "enable_light_reconciliation": true,
    "reconciliation_limit": 100,
    "max_deferred_retry": 3
  }
}
```

创建 `api_keys.json` 文件：

```json
{
  "api_key": "your_binance_api_key",
  "secret_key": "your_binance_secret_key"
}
```

### 3. 编译和运行

```bash
# 编译
go build -o binance-grid-trader

# 启动交易系统
go run main.go
```

## 使用说明

### 启动流程

1. **系统初始化**
   - 加载配置文件
   - 初始化存储系统
   - 创建API客户端

2. **恢复流程**
   - 加载最新快照
   - 重放事件日志
   - 执行轻对账
   - 处理延迟订单

3. **网格创建**
   - 获取当前价格
   - 创建X/A/B段网格
   - 启动网格引擎

4. **开始交易**
   - 连接WebSocket
   - 监听订单更新
   - 处理执行回报
   - 实时配对处理

### 监控和管理

系统提供了完整的监控功能：

- **实时统计**：订单数量、执行数量、配对统计
- **健康检查**：WebSocket连接、网格状态、API状态
- **错误监控**：错误分类、重试统计、成功率
- **性能指标**：延迟统计、吞吐量、内存使用

### 状态管理

系统支持三种运行状态：

1. **NORMAL**：正常运行状态
2. **DEGRADED**：降级模式（WebSocket断开）
3. **RECOVERING**：恢复模式（重新连接中）

## 测试

系统包含完整的测试覆盖：
- 存储系统测试
- 错误处理测试
- 配对引擎测试
- 恢复管理器测试
- 多网格管理器测试
- 集成测试

可以通过Go的标准测试工具运行测试：

```bash
go test ./...
```
- 配对引擎演示
- 多网格管理演示
- 错误处理演示

## 文件结构

```
binance-grid-trader/
├── types/              # 数据结构定义
│   ├── types.go        # 核心数据类型
│   └── tables.go       # 内存表实现
├── storage/            # 存储系统
│   └── storage.go      # 文件系统实现
├── pairing/            # 配对引擎
│   └── pairing.go      # 订单配对逻辑
├── recovery/           # 恢复系统
│   └── recovery.go     # 启动恢复流程
├── multigrid/          # 多网格管理
│   └── multigrid.go    # 多网格引擎
├── errors/             # 错误处理
│   └── errors.go       # 错误分类和处理
├── binance/            # 币安API客户端
│   └── client.go       # API封装
├── websocket/          # WebSocket客户端
│   └── client.go       # WebSocket封装
├── config/             # 配置管理
│   └── config.go       # 配置加载
├── main.go             # 主程序入口
└── README.md           # 说明文档
```

## 数据文件

系统运行时会创建以下数据文件：

```
data/
├── ledger.jsonl        # 事件日志
├── snapshot.json       # 系统快照
├── deferred_queue.jsonl # 延迟订单
├── rejections.jsonl    # 拒绝记录
└── logs/               # 日志目录
    ├── system.log      # 系统日志
    ├── trading.log     # 交易日志
    └── error.log       # 错误日志
```

## 安全注意事项

1. **API密钥安全**
   - 不要将API密钥提交到版本控制
   - 使用只读或期货交易权限
   - 定期轮换API密钥

2. **资金管理**
   - 建议在测试网先测试
   - 设置合理的网格参数
   - 监控账户余额变化

3. **风险控制**
   - 设置止损机制
   - 监控市场异常波动
   - 定期检查系统状态

## 故障排除

### 常见问题

1. **WebSocket连接失败**
   - 检查网络连接
   - 验证API密钥权限
   - 查看错误日志

2. **订单提交失败**
   - 检查账户余额
   - 验证交易对设置
   - 查看拒绝记录

3. **配对异常**
   - 检查GridLegID生成
   - 验证订单状态
   - 运行完整性检查

### 日志分析

系统提供详细的日志记录：

- `system.log`: 系统启动、关闭、状态变化
- `trading.log`: 订单、执行、配对记录
- `error.log`: 错误详情和堆栈信息

## 性能优化

1. **内存优化**
   - 定期清理历史数据
   - 优化内存表大小
   - 监控内存使用

2. **网络优化**
   - 使用连接池
   - 实现请求重试
   - 监控API延迟

3. **存储优化**
   - 定期压缩日志文件
   - 优化快照频率
   - 使用SSD存储

## 贡献指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 创建 Pull Request

## 许可证

MIT License

## 联系方式

如有问题或建议，请创建 Issue 或联系开发团队。

---

**免责声明**: 本软件仅供学习和研究使用，使用者需要承担所有交易风险。作者不对任何交易损失负责。